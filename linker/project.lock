download-sefaria-dump:
  cmd: python -m spacy run download-sefaria-dump
  script:
    - sh scripts/restore_db.sh
  deps:
    - path: scripts/restore_db.sh
      md5: 5cafcd94fb535ddb8a8c93def7173a16
  outs: []
  spacy_version: 3.2.0
  spacy_git_version: 0fc3dee77
export-library:
  cmd: python -m spacy run export-library
  script:
    - python scripts/library_exporter.py he -f both -w ../web_scraper/output -o corpus/all_text_he
      -s
  deps:
    - path: scripts/restore_db.sh
      md5: 5cafcd94fb535ddb8a8c93def7173a16
  outs:
    - path: corpus/all_text_he.txt
      md5: 83624b4ae4db80d4589ed0f859124977
    - path: corpus/all_text_he.jsonl
      md5: 68be3fbb4b055f397f8b1060cd1fb7e1
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
train-floret:
  cmd: python -m spacy run train-floret
  script:
    - python scripts/train_floret.py --model cbow --dim 300 --mincount 10 --minn 3
      --maxn 6 --neg 10 --mode floret --hashcount 2 --bucket 20000 --thread 8 --epoch
      10 corpus/all_text_he.txt vectors/all_text_he
  deps:
    - path: scripts/train_floret.py
      md5: 24ec6c00e168a5981011fe4197d5363a
    - path: corpus/all_text_he.txt
      md5: b7d8247426edd71f3997b13aa1e2c6ce
  outs:
    - path: vectors/all_text_he.floret
      md5: cd6203ee6ce18b3128f34914c8326bdc
    - path: vectors/all_text_he.vec
      md5: d76bf8f8f46214262ee0723ea83b14b3
    - path: vectors/all_text_he.bin
      md5: 1cc8b117091f5c789c4e18499b190005
  spacy_version: 3.2.0
  spacy_git_version: 0fc3dee77
init-floret-vectors:
  cmd: python -m spacy run init-floret-vectors
  script:
    - python -m spacy init vectors he vectors/all_text_he.floret vectors/all_text_he_floret_model
      --mode floret
  deps:
    - path: vectors/all_text_he.floret
      md5: cd6203ee6ce18b3128f34914c8326bdc
  outs:
    - path: vectors/all_text_he_floret_model
      md5: 5df72df9cb56bde99737791079b07b0a
  spacy_version: 3.2.0
  spacy_git_version: 0fc3dee77
train-fasttext:
  cmd: python -m spacy run train-fasttext
  script:
    - python scripts/embedding_scripts.py fasttext -d 26 -i corpus/all_text_he.txt
      -o vectors/all_text_he.fasttext_26
  deps:
    - path: scripts/embedding_scripts.py
      md5: b2fcd20002ce6da4147a5475f9bbe866
    - path: corpus/all_text_he.txt
      md5: 83624b4ae4db80d4589ed0f859124977
  outs:
    - path: vectors/all_text_he.fasttext_26.bin
      md5: 4ed2dbe55cf827c170aa35ae3f1d3720
    - path: vectors/all_text_he.fasttext_26.vec
      md5: b3dfabda15c2be4a4884208f422cb542
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
init-fasttext-vectors:
  cmd: python -m spacy run init-fasttext-vectors
  script:
    - python -m spacy init vectors he vectors/all_text_he.fasttext_26.vec vectors/all_text_he_fasttext_model_26
  deps:
    - path: vectors/all_text_he.fasttext_26.vec
      md5: b3dfabda15c2be4a4884208f422cb542
  outs:
    - path: vectors/all_text_he_fasttext_model_26
      md5: f1840531db94b0c9f3d5e722b4bfed50
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
pretrain:
  cmd: python -m spacy run pretrain
  script:
    - python -m spacy pretrain configs/ref-v3.2.cfg models/pretrain_ref_he_50 --paths.vectors
      vectors/all_text_he_fasttext_model_50 --paths.raw_text corpus/all_text_he.jsonl
      --paths.input_collection webpages_output --nlp.lang he --pretraining.objective.hidden_size
      50 --code ../util/spacy_registry.py --gpu-id 0
  deps:
    - path: configs/ref-v3.2.cfg
      md5: 8fca37256dbe38f46e21e8d667060841
    - path: vectors/all_text_he_fasttext_model_50
      md5: 1b2174b25b5a805cdc7ef7929fb4fa71
  outs:
    - path: models/pretrain_ref_he_50
      md5: 55e41d21c588fd8e3d112341fb9cb26d
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
train-ref-model:
  cmd: python -m spacy run train-ref-model
  script:
    - python ../util/merge_collections.py -o merged_output -c webpages_output achronim_output
      gilyon_output:100
    - python -m spacy train configs/ref-v3.2.cfg --output models/webpages_he_achronim
      --paths.vectors vectors/all_text_he_fasttext_model_50 --paths.input_collection
      merged_output --nlp.lang he --paths.init_tok2vec models/pretrain_ref_he_50/model7.bin
      --pretraining.objective.hidden_size 50 --code ../util/spacy_registry.py --gpu-id
      0
  deps:
    - path: configs/ref-v3.2.cfg
      md5: 90715e0c842b0db74983a8974920f814
    - path: models/pretrain_ref_he_50
      md5: 8aa8996acaed74c543916717b059ad05
  outs:
    - path: models/webpages_he
      md5: null
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
upload-models:
  cmd: python -m spacy run upload-models
  script:
    - kubectl exec -it annotator-bodum-0 -- rm -rf /prodigy-disk/webpages_he
    - kubectl exec -it annotator-bodum-0 -- mv models/webpages_he/model-best /prodigy-disk/webpages_he
    - kubectl exec -it annotator-bodum-0 -- rm -rf models /prodigy-disk/webpages_he.tar
    - rm -rf models/webpages_he.tar
    - tar cf models/webpages_subref_he.tar models/webpages_subref_he/model-best
    - krsync.sh -av --progress --stats models/webpages_subref_he.tar annotator-bodum-0:/prodigy-disk/webpages_subref_he.tar
    - kubectl exec -it annotator-bodum-0 -- tar xf /prodigy-disk/webpages_subref_he.tar
    - kubectl exec -it annotator-bodum-0 -- rm -rf /prodigy-disk/webpages_subref_he
    - kubectl exec -it annotator-bodum-0 -- mv models/webpages_subref_he/model-best
      /prodigy-disk/webpages_subref_he
    - kubectl exec -it annotator-bodum-0 -- rm -rf models /prodigy-disk/webpages_subref_he.tar
    - rm -rf models/webpages_subref_he.tar
  deps: []
  outs: []
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
train-subref-model:
  cmd: python -m spacy run train-subref-model
  script:
    - python ../util/merge_collections.py -o merged_subref_output -c webpages_sub_citation_output
      gilyon_sub_citation_output
    - python -m spacy train configs/subref-v3.2.cfg --output models/webpages_subref_he
      --paths.vectors vectors/all_text_he_fasttext_model_50 --paths.input_collection
      merged_subref_output --nlp.lang he --paths.init_tok2vec models/pretrain_ref_he_50/model7.bin
      --pretraining.objective.hidden_size 50 --code ../util/spacy_registry.py --gpu-id
      0
  deps:
    - path: configs/subref-v3.2.cfg
      md5: 7a8f45800ee3c5d3878124a91479a0a5
    - path: models/pretrain_ref_he_50
      md5: 8aa8996acaed74c543916717b059ad05
  outs:
    - path: models/webpages_subref_he
      md5: c7c80ac228823c1bade6664ae62744bb
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
train-blank-pretrained-model:
  cmd: python -m spacy run train-blank-pretrained-model
  script:
    - python ../util/merge_collections.py -o merged_output -c achronim_output:2
    - python -m spacy train configs/ref-v3.2.cfg --output models/pretrain_usable --paths.vectors
      vectors/all_text_he_fasttext_model --paths.input_collection merged_output --nlp.lang
      he --paths.init_tok2vec models/pretrain_ref_he/model8.bin --training.max_steps
      1 --code ../util/spacy_registry.py --gpu-id 0
  deps:
    - path: configs/ref-v3.2.cfg
      md5: 877138d37cd69e047c0cd5c5cc09bd8c
    - path: models/pretrain_ref_he
      md5: f141fc80ccfe57855dabf3eadcd6eb99
  outs:
    - path: models/pretrain_usable
      md5: 1c72c5ac3459f07fecebb1f6e318d28d
  spacy_version: 3.2.3
  spacy_git_version: 99425de36
